<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Using org-babel with python.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Python with Org-Babel | The Cloistered Monkey</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://necromuralist.github.io/posts/python-with-org-babel/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="manifest" href="../../site.webmanifest">
<meta name="author" content="Cloistered Monkey">
<link rel="prev" href="../svc-c-value-and-accuracy/" title="SVC C-value and Accuracy" type="text/html">
<link rel="next" href="../org-babel-cheat-sheet/" title="Org-Babel Cheat Sheet" type="text/html">
<meta property="og:site_name" content="The Cloistered Monkey">
<meta property="og:title" content="Python with Org-Babel">
<meta property="og:url" content="https://necromuralist.github.io/posts/python-with-org-babel/">
<meta property="og:description" content="Using org-babel with python.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-12-28T14:12:41-08:00">
<meta property="article:tag" content="babel">
<meta property="article:tag" content="how-to">
<meta property="article:tag" content="literate programming">
<meta property="article:tag" content="python">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-light
bg-light
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="../../">

            <span id="blog-title">The Cloistered Monkey</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../pages/" class="nav-link">Pages</a>
                </li>
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS feed</a>
            </li>
<li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Projects</a>
            <div class="dropdown-menu">
                    <a href="https://necromuralist.github.io/Bowling-For-Data/" class="dropdown-item">Bowling For Data</a>
                    <a href="https://necromuralist.github.io/Anechoic-Echolalia/" class="dropdown-item">Anechoic Echolalia</a>
                    <a href="https://necromuralist.github.io/Ape-Iron/" class="dropdown-item">Ape Iron</a>
                    <a href="https://necromuralist.github.io/Neurotic-Networking/" class="dropdown-item">Neurotic Networking</a>
                    <a href="https://necromuralist.github.io/student_intervention/" class="dropdown-item">Student Intervention Project</a>
                    <a href="https://necromuralist.github.io/boston_housing/" class="dropdown-item">Boston Housing Project</a>
                    <a href="https://necromuralist.github.io/data_science/" class="dropdown-item">Data Science With Python</a>
                    <a href="https://necromuralist.github.io/Visions-Voices-Data/" class="dropdown-item">Visions, Voices, Data</a>
            </div>

                
            </li>
</ul>
<!-- Google custom search --><form method="get" action="https://www.google.com/search" class="navbar-form navbar-right" role="search">
<div class="form-group">
<input type="text" name="q" class="form-control" placeholder="Search">
</div>
<!-- 
<button type="submit" class="btn btn-primary">
	<span class="glyphicon glyphicon-search"></span>
</button>
-->
<input type="hidden" name="sitesearch" value="https://necromuralist.github.io/">
</form>
<!-- End of custom search -->


            <ul class="navbar-nav navbar-right">
<li class="nav-item">
    <a href="index.org" id="sourcelink" class="nav-link">Source</a>
    </li>


                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Python with Org-Babel</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/cloistered-monkey/">Cloistered Monkey</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2016-12-28T14:12:41-08:00" itemprop="datePublished" title="2016-12-28 14:12">2016-12-28 14:12</time></a>
            </p>
            
        <p class="sourceline"><a href="index.org" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div id="outline-container-orge34138c" class="outline-2">
<h2 id="orge34138c">What is this about?</h2>
<div class="outline-text-2" id="text-orge34138c">
<p>
This is an initial look at how to use org-babel to create a literate-programming document. In the past I have used jupyter notebooks and pweave to do similar things, with each having a separate role - jupyter notebooks are good for interactive exploration but somewhat less amenable to working with sphinx (which I did with pweave). The hope here is that the org-babel system will provide something more amenable to both. Since you still have to convert the org-files to restructured text files (with pandoc or ox-nikola) it's still not everything I wanted, but hopefully this will make things a little easier
</p>

<p>
Most of this is stolen from <a href="http://home.fnal.gov/~neilsen/notebook/orgExamples/org-examples.html">this page</a> - I'm fairly new to org-babel in general so I'm just walking in other people's footsteps for now.
</p>

<p>
Also, the inclusion of the org-babel code turned out to be both tedious and aesthetically unsatisfying so I didn't do it as much as I thought I would. The original org-file is <a href="https://raw.githubusercontent.com/necromuralist/necromuralist.github.io/master/posts/python-with-org-babel/index.org">here</a>.
</p>
</div>
</div>
<div id="outline-container-org41397ba" class="outline-2">
<h2 id="org41397ba">High-Level Module Structure</h2>
<div class="outline-text-2" id="text-org41397ba">
<p>
One nice thing about the org-babel/noweb system is that it has a system that makes it easy to create a template (in this case based on the the module structure from <a href="http://python.net/~goodger/projects/pycon/2007/idiomatic/handout.html#module-structure">Code Like A Pythonista</a>) with parts that we're updating inserted using the noweb syntax. To actually see this I had to include the python code as an org-mode snippet so the syntax highlighting isn't there. 
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
This is what the final file looks like once the no-web substitutions happen.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
To create the `literate.py` file (and all the other code-files) you see above execute <code>M-x org-babel-tangle</code>.
</p>
</module></module>
</div>
</div>

<div id="outline-container-org2080ad0" class="outline-2">
<h2 id="org2080ad0">LiterateClass</h2>
<div class="outline-text-2" id="text-org2080ad0">
<p>
This is the class definition that get substituted above. The code block for the definition is named <code>LiterateClass-definition</code> so the main template will substitute its contents for <code>&lt;&lt;LiterateClass-definition&gt;&gt;</code> when it gets tangled.
</p>

<p>
<img src="literate_python/literateclass.png" alt="nil"></p>


Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'
</module>
</div>
</div>

<div id="outline-container-orgeb26cf6" class="outline-2">
<h2 id="orgeb26cf6">Main functions</h2>
<div class="outline-text-2" id="text-orgeb26cf6">
<p>
The <b>Code Like a Pythonista</b> template expects that you are creating a command-line executable with a <b>main</b> entry-point. This section implements that case as an example.
</p>

<p>
First the <code>&lt;&lt;literate-main-imports&gt;&gt;</code>.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
Now the <code>&lt;&lt;literate-main&gt;&gt;</code>.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
As a quick check we can run the code at the command line to see that it's working (the main block has to be tangled for this to work).
</p>
Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<pre class="example">
Who: Not Me
</pre>
</module></module></module>
</div>
</div>

<div id="outline-container-org12efaa5" class="outline-2">
<h2 id="org12efaa5">Testing</h2>
<div class="outline-text-2" id="text-org12efaa5">
<p>
One nice thing about the org-babel infrastructure is that the tests and source can be put in the same org-file, then exported to separate files to be run.
</p>
</div>
<div id="outline-container-org4854be2" class="outline-3">
<h3 id="org4854be2">Doctest</h3>
<div class="outline-text-3" id="text-org4854be2">
<p>
For the stdout output, doctesting can be a convenient way to check that things are behaving as expected while also providing an explicit example of how to run the command-line interface.
</p>
</div>
<div id="outline-container-org796f9bb" class="outline-4">
<h4 id="org796f9bb">Setting up the cases</h4>
<div class="outline-text-4" id="text-org796f9bb">
<p>
The output of a successful doctest is nothing, which is good for automated tests but less interesting here so I'll make a doctest that passes and one that should fail.
</p>

<p>
This next section (named <code>literate-doctest</code>) creates a code snippet that will pass. 
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
And now here's a test (named <code>literate-bad-doctest</code>) that will fail.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
This next section will include the two doctests and export them to a file so they can be tested. Note that you need an empty line between the tests for both of them to run. Warning - since this file is going to be exported, if you are using <code>nikola</code> or some other system that assumes all files with a certain file-extension are blog-posts you have to use an extension that won't get picked up (in my case both <code>rst</code> and <code>txt</code> were interpreted as blog-posts).
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
Which gets tangled into this. Note that the doctests aren't valid python so you can tangle this but not execute it.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'
</module></module></module></module>
</div>
</div>

<div id="outline-container-org559b82e" class="outline-4">
<h4 id="org559b82e">Running the doctests</h4>
<div class="outline-text-4" id="text-org559b82e">
<p>
Now we can actually run them with python to see what happens.
</p>
Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<pre class="example" id="org8c8efbd">
**********************************************************************
File "literate_python/test_literate_output.doctest", line 9, in test_literate_output.doctest
Failed example:
    bad_thing()
Expected:
    Who: Magilla Gorilla
Got:
    Who: Gorilla Glue
**********************************************************************
1 items had failures:
   1 of   5 in test_literate_output.doctest
***Test Failed*** 1 failures.
</pre>

<p>
Note that since this returned a non-zero exit code (I think) you need to put <code>true</code> in the code block or there would be no output.
</p>
</module>
</div>
</div>
</div>

<div id="outline-container-orgc3c6da7" class="outline-3">
<h3 id="orgc3c6da7">PyTest BDD</h3>
<div class="outline-text-3" id="text-orgc3c6da7">
<p>
While doctests are neat I prefer unit-testing, in particular using Behavior Driven Development (BDD) facilitated in this case by <code>py.test</code> and <code>pytest_bdd</code>.
</p>
</div>

<div id="outline-container-orgcbac528" class="outline-4">
<h4 id="orgcbac528">The feature file</h4>
<div class="outline-text-4" id="text-orgcbac528">
<p>
Identifying the code-block with <code>#+begin_src feature</code> adds some syntax highlighting (if you have feature-mode installed and set-up). This works both when you are in the external editor and in the main org-babel document as well.
</p>

<p>
To make sure that org-babel recognizes feature mode add this to the <code>init.el</code> file.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
This is what is going in the feature file.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'
</module></module>
</div>
</div>

<div id="outline-container-org9f385fb" class="outline-4">
<h4 id="org9f385fb">The test file</h4>
<div class="outline-text-4" id="text-org9f385fb">
<p>
This is another file that gets tangled out. In this case it is so that we can run <code>py.test</code> on it.
</p>
Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'
</module>
</div>
</div>

<div id="outline-container-orgd9e7a26" class="outline-4">
<h4 id="orgd9e7a26">Running the test</h4>
<div class="outline-text-4" id="text-orgd9e7a26">
<p>
One important thing to note is that this will put an error message in a separate buffer if something goes wrong (like you don't have py.test installed), which in at least some cases makes it look like it failed silently. Unlike with the doctests, no output means something in the setup needs to be fixed, so you should tangle the file and then run it at the command-line to debug what happened.
</p>
Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<pre class="example" id="org7a9eb40">
============================= test session starts ==============================
platform linux -- Python 3.5.1+, pytest-3.0.5, py-1.4.32, pluggy-0.4.0 -- /home/cronos/.virtualenvs/nikola/bin/python3
cachedir: .cache
rootdir: /home/cronos/projects/nikola/posts, iniimg-url: 
plugins: faker-2.0.0, bdd-2.18.1
collecting ... collected 1 items

literate_python/testliterate.py::test_constructor PASSED

=========================== 1 passed in 0.04 seconds ===========================
</pre>
</module>
</div>
</div>
</div>
</div>
<div id="outline-container-org47ca252" class="outline-2">
<h2 id="org47ca252">Getting This Into Nikola</h2>
<div class="outline-text-2" id="text-org47ca252">
<p>
I tried three ways to get this document into nikola:
</p>
<ul class="org-ul">
<li>converting to rst with pandoc</li>
<li>exporting it with <a href="https://github.com/masayuko/ox-nikola">ox-nikola</a>
</li>
<li>using the <a href="https://plugins.getnikola.com/#orgmode">orgmode</a> plugin for nikola</li>
</ul>
<p>
<b>ox-nikola</b> worked (as did pandoc), but at the moment I'm trying to use the <b>orgmode</b> plugin so that I can keep editing this document without having to convert back and forth. This is turning out to be about the same amount of work as using jupyter (and with a steeper learning curve). But I like the folding and navigation that org-mode offers, so I'll stick with it for a bit. I'm just using the default set-up right now. It seems to work. 
</p>

<p>
The main problem I had initially was the same one I had with jupyter - I'm starting with a file that wasn't generated by the <code>nikola new_post</code> sub-command so it didn't have the header that <b>nikola</b> expected but the only error <code>nikola build</code> reported was an invalid date format. 
</p>

<p>
This is what needs to be at the top of the org-file for nikola to work with it (or something like it).
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
The other thing is that the org-mode plugin doesn't seem to copy over the png-files correctly (or at all) so I had to create a <code>files/posts/python-with-org-babel/literate_python</code> folder and move the UML diagram over there by hand. Lastly, it didn't color the feature file and since there's no intermediate rst-file I don't really know how to fix this. Either I'm going to have to learn a lot more about org-mode than I might want to, or for cases where I want more control over things I'll use <b>ox-nikola</b> to convert it to rst first and edit it. That kind of wrecks the one-document idea, but I guess it would also give me a reason to re-work and polish things instead of improvising everything.
</p>
</module>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/babel/" rel="tag">babel</a></li>
            <li><a class="tag p-category" href="../../categories/how-to/" rel="tag">how-to</a></li>
            <li><a class="tag p-category" href="../../categories/literate-programming/" rel="tag">literate programming</a></li>
            <li><a class="tag p-category" href="../../categories/python/" rel="tag">python</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../svc-c-value-and-accuracy/" rel="prev" title="SVC C-value and Accuracy">Previous post</a>
            </li>
            <li class="next">
                <a href="../org-babel-cheat-sheet/" rel="next" title="Org-Babel Cheat Sheet">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents © 2023         <a href="mailto:cloisteredmonkey.jmark@slmail.me">Cloistered Monkey</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
