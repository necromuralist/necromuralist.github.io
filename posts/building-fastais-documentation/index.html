<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Adventures in building fastai's documentation." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Building fastai's Documentation | The Cloistered Monkey</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/posts/building-fastais-documentation/" rel="canonical"><!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]-->
<link href="../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../coding-strip/" rel="prev" title="Coding Strip" type="text/html">
<link href="../emacs-artifact-on-kubuntu/" rel="next" title="Emacs Scrollbar Artifact on Kubuntu" type="text/html">
<meta content="The Cloistered Monkey" property="og:site_name">
<meta content="Building fastai's Documentation" property="og:title">
<meta content="https://necromuralist.github.io/posts/building-fastais-documentation/" property="og:url">
<meta content="Adventures in building fastai's documentation." property="og:description">
<meta content="article" property="og:type">
<meta content="2021-05-29T12:31:38-07:00" property="article:published_time">
<meta content="documentation" property="article:tag">
<meta content="fastai" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../"><span id="blog-title">The Cloistered Monkey</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../pages/">Pages</a></li>
<li class="nav-item"><a class="nav-link" href="../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../rss.xml">RSS feed</a></li>
<li class="nav-item dropdown"><a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Projects</a>
<div class="dropdown-menu"><a class="dropdown-item" href="https://necromuralist.github.io/Ape-Iron/">Ape Iron</a> <a class="dropdown-item" href="https://necromuralist.github.io/Beach-Pig-Thigh/">Beach Pig Rump & Thigh</a> <a class="dropdown-item" href="https://necromuralist.github.io/Bowling-For-Data/">Bowling For Data</a> <a class="dropdown-item" href="https://necromuralist.github.io/Give-The-Fish/">Give the Fish</a> <a class="dropdown-item" href="https://necromuralist.github.io/Neurotic-Networking/">Neurotic Networking</a> <a class="dropdown-item" href="https://necromuralist.github.io/Terribilis-Ludum/">Terribilis Ludum</a> <a class="dropdown-item" href="https://necromuralist.github.io/Visions-Voices-Data/">Visions, Voices, Data</a></div>
</li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Building fastai's Documentation</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author"><a class="u-url" href="../../authors/cloistered-monkey/">Cloistered Monkey</a></span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2021-05-29T12:31:38-07:00" itemprop="datePublished" title="2021-05-29 12:31">2021-05-29 12:31</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgb9224cd">What is this about?</a></li>
<li><a href="#org54685d7">What happened?</a>
<ul>
<li><a href="#orga4ea474">The Repository</a></li>
<li><a href="#org3f15384">Jekyll and Hide</a>
<ul>
<li><a href="#org02b27b7">All You Need</a></li>
</ul>
</li>
<li><a href="#orgf8ccd7d">Fixing the Imports</a>
<ul>
<li><a href="#org3a4474b">Installing fastai</a></li>
<li><a href="#org157db34">Installing Flask Compress</a></li>
<li><a href="#orgb974b03">Install Azureml-core</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orge55b415">In A Nutshell</a>
<ul>
<li>
<ul>
<li><a href="#orgdb51ace">The Minimum to Get the Documentation</a></li>
<li><a href="#orgdefb506">To Fix All the Errors</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="outline-2" id="outline-container-orgb9224cd">
<h2 id="orgb9224cd">What is this about?</h2>
<div class="outline-text-2" id="text-orgb9224cd">
<p>I've decided to try and build as much of the documentation that I use all the time on my local system, not just so that I'll have it if my internet connection goes down but also so that I won't be distracted by what's happening on the web. This is about building <a href="https://docs.fast.ai/">fastai's documentation</a>, which was a little trickier than I thought it would be so I decided it would be worth it to make a note for the future.</p>
<p>You can skip to the <a href="#orge55b415">In A Nutshell</a> section of the post to get a summary of the steps without all the exposition that the middle section has.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org54685d7">
<h2 id="org54685d7">What happened?</h2>
<div class="outline-text-2" id="text-org54685d7"></div>
<div class="outline-3" id="outline-container-orga4ea474">
<h3 id="orga4ea474">The Repository</h3>
<div class="outline-text-3" id="text-orga4ea474">
<p>The first thing I did was clone the <a href="https://github.com/fastai/fastai">fastai git repository</a> from github. If you inspect it there's a folder called <code>docs_src</code> which seemed to logically mean that that's where the source files for the documentation are but when you go in there you won't find an <code>index.html</code> file, which seemed peculiar. There's a <code>Makefile</code> at the root of the repository so I inspected it and found that there's a rule:</p>
<pre class="example">
docs: $(SRC)
        rsync -a docs_src/ docs
        nbdev_build_docs
</pre>
<p>So I tried a naive <code>make docs</code> but of course it failed because there's nothing called <code>nbdev_build_docs</code>, so I searched online and found out that <a href="https://nbdev.fast.ai/">nbdev</a> is a fastai project to make jupyter notebooks into a <a href="https://www.wikiwand.com/en/Literate_programming">Literate Programming</a> system and that <code>nbdev_build_docs</code> is one of their command-line commands, so I installed it through pip:</p>
<pre class="example">
pip install nbdev
</pre>
<p>And re-ran the make command, which did nothing because the <code>rsync</code> command had already created the <code>docs</code> folder and for some reason this made the <code>nbdev_build_docs</code> command not work. So I removed the <code>docs</code> folder and re-ran it, which produced a big dump of errors because in converting the notebooks <code>nbdev</code> was importing a bunch of python code that wasn't installed. Interestingly, at this point the <code>docs</code> folder actually has enough to run the site, despite all the error-messages, but if you just try to load the files into a browser you can see that it's kind of broken, so then I went looking for what was going on.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org3f15384">
<h3 id="org3f15384">Jekyll and Hide</h3>
<div class="outline-text-3" id="text-org3f15384">
<p>For some reason I couldn't find anything in the documentation on building it, but searching for <i>"fastai build documentation"</i> brought an <a href="https://fastai1.fast.ai/gen_doc_main.html">outdated page</a> that tells you how to build the documentation but was written for the prior version of fastai (v1) so much of it doesn't make sense for v2 (e.g. it refers to a non-existent <code>tools</code> folder), which I didn't figure out at first because the sites for v1 and v2 don't really identify their version, except in the URL for the old site.</p>
</div>
<div class="outline-4" id="outline-container-org02b27b7">
<h4 id="org02b27b7">All You Need</h4>
<div class="outline-text-4" id="text-org02b27b7">
<p>Reading that documentation it turns out that they're using <a href="https://jekyllrb.com/">Jekyll</a>, so if you <a href="https://jekyllrb.com/docs/installation/">install it</a> you just need to run Jekyll in the <code>docs</code> folder.</p>
<pre class="example">
cd docs
bundle exec jekyll serve
</pre>
<p>And the site is ready to read at <code>http://localhost:4000</code> and at this point you're good to go - but, of course, I didn't realize that and tried to fix the error messages first, which is what the rest of this post is about.</p>
</div>
</div>
</div>
<div class="outline-3" id="outline-container-orgf8ccd7d">
<h3 id="orgf8ccd7d">Fixing the Imports</h3>
<div class="outline-text-3" id="text-orgf8ccd7d">
<p>There's three things you need to do to fix the imports:</p>
<ul class="org-ul">
<li>install fastai and any dependencies</li>
<li>install <a href="https://github.com/colour-science/flask-compress"><code>flask_compress</code></a></li>
<li>install <a href="https://github.com/Azure/azure-sdk-for-python"><code>azureml-core</code></a></li>
</ul>
</div>
<div class="outline-4" id="outline-container-org3a4474b">
<h4 id="org3a4474b">Installing fastai</h4>
<div class="outline-text-4" id="text-org3a4474b">
<p><a href="https://fastai1.fast.ai/gen_doc_main.html#step-2-setup">The old documentation</a> recommended installing it in development mode. I don't know if that's strictly necessary, but it fixed a lot of things so it seems like a good idea.</p>
<p>In the root of the fastai repository run pip.</p>
<pre class="example">
pip install -e ".[dev]"
</pre>
<p>This installs a lot of stuff so you might want to go get a cup of coffee (or maybe a cocktail) at this point while it does its thing. The <code>settings.ini</code> file lists the <code>dev_requirements</code> and the regular requirements if you want to see what needs to be installed in either case.</p>
</div>
</div>
<div class="outline-4" id="outline-container-org157db34">
<h4 id="org157db34">Installing Flask Compress</h4>
<div class="outline-text-4" id="text-org157db34">
<p>This is pretty straight-forward, just use pip.</p>
<pre class="example">
pip install flask-compress
</pre></div>
</div>
<div class="outline-4" id="outline-container-orgb974b03">
<h4 id="orgb974b03">Install Azureml-core</h4>
<div class="outline-text-4" id="text-orgb974b03"></div>
<ul class="org-ul">
<li><a id="org027abeb"></a>The Problem<br>
<div class="outline-text-5" id="text-org027abeb">
<p>This wasn't quite so straight-forward, which is why I put it in a separate section. If you try to install it in Ubuntu 21.04 (or 20.04, etc.) you will get a big blob of error messages ending in this.</p>
<pre class="example">
ERROR: Command errored out with exit status 1: /home/hades/.virtualenvs/fastai-clean/bin/python -u -c 'import io, os, sys, setuptools, tokenize; sys.argv[0] = '"'"'/tmp/pip-install-srnkqokl/ruamel-yaml_803314568
e8f4fa49015a45528d277b2/setup.py'"'"'; __file__='"'"'/tmp/pip-install-srnkqokl/ruamel-yaml_803314568e8f4fa49015a45528d277b2/setup.py'"'"';f = getattr(tokenize, '"'"'open'"'"', open)(__file__) if os.path.exists(_
_file__) else io.StringIO('"'"'from setuptools import setup; setup()'"'"');code = f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' install --record /tmp/pip
-record-yfvqflby/install-record.txt --single-version-externally-managed --compile --install-headers /home/hades/.virtualenvs/fastai-clean/include/site/python3.9/ruamel.yaml Check the logs for full command output
</pre>
<p>Which isn't really all that helpful. Scrolling up, it looks like the problem was with something called <a href="https://yaml.readthedocs.io/en/latest/">ruamel.yaml</a>, so investigating this seemed like a place to start, but, of course, the error messages are completely inscrutable now that I haven't programmed in C for so many years so I decided to search the web instead of trying to debug it directly, figuring that someone else must have had this problem.</p>
<p>This lead to a long search through various posts, but what it turned out to be was that both ruamel.yaml and azureml-core don't support python 3.9 yet (there are some <a href="https://github.com/Azure/MachineLearningNotebooks/issues?q=is%3Aissue+is%3Aopen+3.9">bug reports on GitHub</a> for it already) so you can't install it with the version that currently ships with Ubuntu (3.9.5) or anything above python 3.8.</p>
</div>
</li>
<li><a id="org49a76ee"></a>The Fix<br>
<div class="outline-text-5" id="text-org49a76ee">
<p>The fix I decided to use was to install <a href="https://github.com/pyenv/pyenv">pyenv</a> using their <a href="https://github.com/pyenv/pyenv-installer">installer</a>. Once you run the installer and follow the rest of their <a href="https://github.com/pyenv/pyenv#installation">installation instructiors</a> it's fairly straightforward to set up so I won't go into it.</p>
<p>I decided to use python 3.8.10 so to install it you do this:</p>
<pre class="example">
pyenv install 3.8.10
</pre>
<p>The only thing that didn't work for me was their <code>pyenv which</code> function which is supposed to show you the location of the python installation. The command might work but I couldn't figure out the arguments to use (updating the example they gave didn't work for me). It turned out the python binary was at:</p>
<pre class="example">
~/.pyenv/versions/3.8.10/bin/python
</pre>
<p>pyenv has it's own system for creating a virtual environment, but since I'm already using virtualfish and didn't want to try and troubleshoot yet another method I created a virtual environment the way I usually do it.</p>
<pre class="example">
~/.pyenv/versions/3.8.10/bin/python -m venv fastai-doc
</pre>
<p>At this point I activated the new virtual environment and had to re-do previous installation steps (for <code>fastai</code> and <code>flask_compress</code>) as well as the azure-ml installation.</p>
<pre class="example">
pip install -e ".[dev]"
pip install flask-compress azureml-core
</pre>
<p>The installation of fastai installs <code>nbdev</code> as one of the requirements so that didn't have to be re-done. And now I built the documentation and ran the jekyll server. Easy-peasy.</p>
<pre class="example">
make docs
cd docs
bundle exec jekyll serve
</pre></div>
</li>
</ul>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orge55b415">
<h2 id="orge55b415">In A Nutshell</h2>
<div class="outline-text-2" id="text-orge55b415"></div>
<div class="outline-4" id="outline-container-orgdb51ace">
<h4 id="orgdb51ace">The Minimum to Get the Documentation</h4>
<div class="outline-text-4" id="text-orgdb51ace">
<ul class="org-ul">
<li>Clone the <a href="https://github.com/fastai/fastai">fastai git repository</a> from github</li>
<li>Install <a href="https://jekyllrb.com/">jekyll</a> and <a href="https://nbdev.fast.ai/">nbdev</a></li>
<li>Change into the root of the fastai repository you cloned</li>
<li>Run <code>make docs</code> and ignore the error-messages</li>
<li>Change into the <code>docs</code> folder that was created and run the jekyll server (<code>bundle exec jekyll serve</code>)</li>
</ul>
</div>
</div>
<div class="outline-4" id="outline-container-orgdefb506">
<h4 id="orgdefb506">To Fix All the Errors</h4>
<div class="outline-text-4" id="text-orgdefb506">
<p>This isn't really necessary to get the documentation, but I think it's better, since you don't have to ignore all the error messages.</p>
<ul class="org-ul">
<li>Clone the <a href="https://github.com/fastai/fastai">fastai git repository</a> from github</li>
<li>Install <a href="https://jekyllrb.com/">jekyll</a></li>
<li>Get python 3.8 working (I used pyenv)</li>
<li>Use pip to install fastai in development mode</li>
<li>Use pip to install <code>flask_compress</code> and <code>azureml-core</code></li>
<li>Change into the root of the fastai repository you cloned</li>
<li>Run <code>make docs</code></li>
<li>Change into the <code>docs</code> folder that was created and run the jekyll server (<code>bundle exec jekyll serve</code>)</li>
</ul>
</div>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../categories/documentation/" rel="tag">documentation</a></li>
<li><a class="tag p-category" href="../../categories/fastai/" rel="tag">fastai</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../coding-strip/" rel="prev" title="Coding Strip">Previous post</a></li>
<li class="next"><a href="../emacs-artifact-on-kubuntu/" rel="next" title="Emacs Scrollbar Artifact on Kubuntu">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer">Scribbled by the <a href="mailto:cloisteredmonkey.jmark@slmail.me">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a>
<div id="license" xmlns:cc="http://creativecommons.org/ns#">This work is licensed under <a href="http://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" rel="license noopener noreferrer" style="display:inline-block;" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"></a></div>
</footer>
</div>
</div>
<script src="../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
