<html><body><div class="document" id="using-pudb-with-behave-and-fish"><h1>What is this about?</h1><div class="section" id="what-is-this-about"><a class="reference external" href="http://pythonhosted.org/behave/">behave</a> is a behavior-driven-development (BDD) tool for python that tests whether you have properly implemented the features you have defined in your <cite>features</cite> file(s). In their <a class="reference external" href="http://pythonhosted.org/behave/tutorial.html">tutorial</a> they tell you how you can set it up so that it will drop into <a class="reference external" href="http://ipython.org/ipython-doc/rel-0.10.2/html/api/generated/IPython.Debugger.html">ipdb</a> (ipython debugger) when a test fails, but I use <a class="reference external" href="https://github.com/inducer/pudb">pudb</a> and the <a class="reference external" href="http://fishshell.com/">fish</a> shell (not <cite>bash</cite>) so this documents what I had to do to get it to work.</div><div class="section" id="how-do-you-do-it-then"><h1>How do you do it then?</h1>The first thing to do is create a file named <cite>environment.py</cite> in the same folder as the <cite>features</cite> file. Inside of it put the following:<br><pre class="literal-block">from distutils.util import strtobool as _bool<br>import os<br><br>BEHAVE_DEBUG_ON_ERROR = _bool(os.environ.get("BEHAVE_DEBUG_ON_ERROR",<br>                                             "no"))<br>def after_step(context, step):<br>    if BEHAVE_DEBUG_ON_ERROR and step.status == 'failed':<br>        import pudb<br>        pudb.post_mortem(tb=step.exc_traceback,<br>                         e_type=None,<br>                         e_value=None)<br>    return<br></pre>This is more-or-less exactly what was in the tutorial except I swapped out <cite>pudb</cite> for <cite>pdb</cite>. This code tells <cite>behave</cite> to run the <cite>pudb.post_mortem</cite> after a step is finished (a step corresponds to one of the functions you define to implement the tests) if the step failed and your shell has an environment variable named <cite>BEHAVE_DEBUG_ON_ERROR</cite> and it is set to something that <cite>strtobool</cite> recognizes as True. This is from the docstring documentation for <a class="reference external" href="https://docs.python.org/2/distutils/apiref.html#module-distutils.util">strtobool</a>:<br><blockquote> <dl class="docutils"><dt>distutils.util.strtobool(val)</dt><dd><div class="first">Convert a string representation of truth to true (1) or false (0).</div><ul class="last simple"><li>True values are <cite>y</cite>, <cite>yes</cite>, <cite>t</cite>, <cite>true</cite>, <cite>on</cite> and <cite>1</cite></li><li>false values are <cite>n</cite>, <cite>no</cite>, <cite>f</cite>, <cite>false</cite>, <cite>off</cite> and <cite>0</cite></li><li>Raises <b>ValueError</b> if val is anything else.</li></ul></dd></dl></blockquote>The 'no' in the <tt class="docutils literal">os.environ.get</tt> function means that it won't execute by default. To have it run you need to set the environment variable to one of the 'true' values. In fish this would be:<br><pre class="literal-block">set -x BEHAVE_DEBUG_ON_ERROR yes<br></pre>Now when you run behave it will drop into pudb when a test fails.</div><div class="section" id="so-what-then"><h1>So, what then?</h1>Using this has so far been less useful than I thought it would be, since it tends to drop me into the <a class="reference external" href="https://pypi.python.org/pypi/PyHamcrest">pyhamcrest</a> call that failed and although I've managed to step through to the <cite>behave</cite> code I haven't managed to figure out how to get to my own code. It is still useful, though, since <cite>behave</cite> will not stop when it encounters a failed test so this makes it easier to figure out what has failed.<br>Even though the <cite>pudb-behave</cite> combination is less exciting than I thought it would be, there were several things I learned that I want to document here for later.<br><div class="section" id="setting-an-environment-variable-in-fish"><h2>Setting an environment variable in fish</h2>To set a fish environment variable:<br><pre class="literal-block">set -x &lt;variable&gt; &lt;value&gt;<br></pre>And then unset it:<br><pre class="literal-block">set -e &lt;variable&gt;<br></pre>I've done this before to set my <tt class="docutils literal">PATH</tt> variable but for some reason when I tried to search for it this time I got some false-starts at first.</div><div class="section" id="python-s-string-to-boolean"><h2>Python's String to Boolean</h2>I also learned that python has a built in way to translate strings to booleans. This isn't really a hard thing to do on your own, but it was an interesting discovery. I don't think I would have looked in <cite>distutils</cite> for it.</div><div class="section" id="pudb-s-post-mortem-function"><h2><cite>pudb's</cite> post_mortem function</h2>Another interesting thing to find out was that <cite>pudb</cite> has a <cite>post_mortem</cite> function. I like <cite>pudb</cite> but it doesn't seem to be well documented. The <tt class="docutils literal">readme</tt> does say that it displays the same interface as python's <cite>pdb</cite> so I suppose I could just read their documentation, but it seems like one of those things where you have to know what you don't know to know to look for it. In this case I figured out how to call it by looking at the code (it's defined in <tt class="docutils literal">pudb.__init__.py</tt>).</div><div class="section" id="using-environment-variables-for-debugging"><h2>Using environment variables for debugging</h2>Probably the most interesting thing was the way they used <cite>os.environ</cite> to change the behavior of the code. I normally use command-line options to enable debugging but this might be a better pattern since it pulls it out of the user interface. This means that it won't be as obvious to the user, but I suppose if they're going to debug my code they had better read the documentation and not just rely on <tt class="docutils literal"><span class="pre">--help</span></tt> anyway. I think I'll probably get rid of in in the <cite>environment.py</cite> file, though, since I want it to run pretty much all the time, but it's an interesting idea anyway.</div></div><div class="section" id="conclusion"><h1>Conclusion</h1>This was a translation of how to set up a post-mortem debugger for behave using <cite>pudb</cite> instead of <cite>ipdb</cite> and <cite>fish</cite> instead of <cite>bash</cite>. It is primarily meant to be a record for me to look at in the future, since I don't set up my <cite>behave</cite> environment on a regular basis and tend to have a hard time re-searching for things (possibly because I use <a class="reference external" href="https://duckduckgo.com/">DuckDuckGo</a> so my search history isn't being used). I think the most valuable thing I got out of it was the pattern for setting up debuggers that I think I'll steal (use) for my own code.</div></div></body></html>