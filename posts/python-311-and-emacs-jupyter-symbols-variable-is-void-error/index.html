<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
<head>
<meta charset="utf-8">
<meta content="Troubleshooting emacs-jupyter with python 3.11." name="description">
<meta content="width=device-width, initial-scale=1" name="viewport">
<title>Ubuntu 22.04, Python 3.11 and the "emacs-jupyter Symbol's variable is void" Error | The Cloistered Monkey</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<meta content="Nikola (getnikola.com)" name="generator">
<link href="../../rss.xml" hreflang="en" rel="alternate" title="RSS" type="application/rss+xml">
<link href="https://necromuralist.github.io/posts/python-311-and-emacs-jupyter-symbols-variable-is-void-error/" rel="canonical"><!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]-->
<link href="../../apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180">
<link href="../../favicon-32x32.png" rel="icon" sizes="32x32" type="image/png">
<link href="../../favicon-16x16.png" rel="icon" sizes="16x16" type="image/png">
<link href="../../site.webmanifest" rel="manifest">
<meta content="Cloistered Monkey" name="author">
<link href="../kernel-panic-at-the-lunar-lobster/" rel="prev" title="Kernel Panic At the Lunar Lobster" type="text/html">
<link href="../fish-mocha-chai-a-local-global-installation-in-ubuntu/" rel="next" title="Fish, Mocha, Chai - A Local Global Installation In Ubuntu" type="text/html">
<meta content="The Cloistered Monkey" property="og:site_name">
<meta content="Ubuntu 22.04, Python 3.11 and the &quot;emacs-jupyter Symbol's variable is" property="og:title">
<meta content="https://necromuralist.github.io/posts/python-311-and-emacs-jupyter-symbols-variable-is-void-error/" property="og:url">
<meta content="Troubleshooting emacs-jupyter with python 3.11." property="og:description">
<meta content="article" property="og:type">
<meta content="2023-05-25T16:12:27-07:00" property="article:published_time">
<meta content="emacs" property="article:tag">
<meta content="jupyter" property="article:tag">
<meta content="python" property="article:tag">
<meta content="troubleshooting" property="article:tag">
<meta content="ubuntu" property="article:tag">
</head>
<body>
<a class="sr-only sr-only-focusable" href="#content">Skip to main content</a> <!-- Menubar -->
<nav class="navbar navbar-expand-md static-top mb-4 navbar-light bg-light">
<div class="container"><!-- This keeps the margins nice -->
 <a class="navbar-brand" href="../../"><span id="blog-title">The Cloistered Monkey</span></a> <button aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler" data-target="#bs-navbar" data-toggle="collapse" type="button"><span class="navbar-toggler-icon"></span></button>
<div class="collapse navbar-collapse" id="bs-navbar">
<ul class="navbar-nav mr-auto">
<li class="nav-item"><a class="nav-link" href="../../pages/">Pages</a></li>
<li class="nav-item"><a class="nav-link" href="../../archive.html">Archive</a></li>
<li class="nav-item"><a class="nav-link" href="../../categories/">Tags</a></li>
<li class="nav-item"><a class="nav-link" href="../../rss.xml">RSS feed</a></li>
<li class="nav-item dropdown"><a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Projects</a>
<div class="dropdown-menu"><a class="dropdown-item" href="https://necromuralist.github.io/Ape-Iron/">Ape Iron</a> <a class="dropdown-item" href="https://necromuralist.github.io/Beach-Pig-Thigh/">Beach Pig Rump & Thigh</a> <a class="dropdown-item" href="https://necromuralist.github.io/Bowling-For-Data/">Bowling For Data</a> <a class="dropdown-item" href="https://necromuralist.github.io/Give-The-Fish/">Give the Fish</a> <a class="dropdown-item" href="https://necromuralist.github.io/Neurotic-Networking/">Neurotic Networking</a> <a class="dropdown-item" href="https://necromuralist.github.io/Terribilis-Ludum/">Terribilis Ludum</a> <a class="dropdown-item" href="https://necromuralist.github.io/Visions-Voices-Data/">Visions, Voices, Data</a></div>
</li>
</ul>
<!-- Google custom search -->
<form action="https://www.google.com/search" class="navbar-form navbar-right" method="get" role="search">
<div class="form-group"><input class="form-control" name="q" placeholder="Search" type="text"></div>
<!-- 
<button type="submit" class="btn btn-primary">
        <span class="glyphicon glyphicon-search"></span>
</button>
-->
<input name="sitesearch" type="hidden" value="https://necromuralist.github.io/"></form>
<!-- End of custom search -->
<ul class="navbar-nav navbar-right">
<li class="nav-item"><a class="nav-link" href="index.org" id="sourcelink">Source</a></li>
</ul>
</div>
<!-- /.navbar-collapse --></div>
<!-- /.container --></nav>
<!-- End of Menubar -->
<div class="container" id="content" role="main">
<div class="body-content"><!--Body content-->
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article">
<header>
<h1 class="p-name entry-title" itemprop="headline name"><a class="u-url" href=".">Ubuntu 22.04, Python 3.11 and the "emacs-jupyter Symbol's variable is void" Error</a></h1>
<div class="metadata">
<p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author"><a class="u-url" href="../../authors/cloistered-monkey/">Cloistered Monkey</a></span></p>
<p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2023-05-25T16:12:27-07:00" itemprop="datePublished" title="2023-05-25 16:12">2023-05-25 16:12</time></a></p>
<p class="sourceline"><a class="sourcelink" href="index.org">Source</a></p>
</div>
</header>
<div class="e-content entry-content" itemprop="articleBody text">
<div class="outline-2" id="outline-container-org89ce998">
<h2 id="org89ce998">What This Is About</h2>
<div class="outline-text-2" id="text-org89ce998">
<p>Ubuntu 22.04 no longer let's you install python packages globally using pip by default (you can override it but they warn you not to). This has caused a cascade of broken parts on my system, since I use python so much. This particular case started with me trying to start the <a href="https://docs.jupyter.org/en/latest/projects/kernels.html"><code>jupyter kernel</code></a> so that I could run some python code in org-mode and getting (what looked like) an error and fixing it ended up uncovering the fact that working with the new policy for pip broke my emacs setup a little too, so this is a dump of how I got it back up and running again. I recorded it as I was fixing things so there might be a better way, but this is the first pass I took.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org2b6e9b9">
<h2 id="org2b6e9b9">The Jupyter Kernel Warning</h2>
<div class="outline-text-2" id="text-org2b6e9b9">
<p>This is what happened when I tried to start the jupyter kernel.</p>
<div class="highlight">
<pre><span></span><span class="o">(</span>Ape-Iron<span class="o">)</span><span class="w"> </span>hades@erebus<span class="w"> </span>~&gt;<span class="w"> </span>jupyter<span class="w"> </span>kernel
<span class="o">[</span>KernelApp<span class="o">]</span><span class="w"> </span>Starting<span class="w"> </span>kernel<span class="w"> </span><span class="s1">'python3'</span>
<span class="m">0</span>.00s<span class="w"> </span>-<span class="w"> </span>Debugger<span class="w"> </span>warning:<span class="w"> </span>It<span class="w"> </span>seems<span class="w"> </span>that<span class="w"> </span>frozen<span class="w"> </span>modules<span class="w"> </span>are<span class="w"> </span>being<span class="w"> </span>used,<span class="w"> </span>which<span class="w"> </span>may
<span class="m">0</span>.00s<span class="w"> </span>-<span class="w"> </span>make<span class="w"> </span>the<span class="w"> </span>debugger<span class="w"> </span>miss<span class="w"> </span>breakpoints.<span class="w"> </span>Please<span class="w"> </span>pass<span class="w"> </span>-Xfrozen_modules<span class="o">=</span>off
<span class="m">0</span>.00s<span class="w"> </span>-<span class="w"> </span>to<span class="w"> </span>python<span class="w"> </span>to<span class="w"> </span>disable<span class="w"> </span>frozen<span class="w"> </span>modules.
<span class="m">0</span>.00s<span class="w"> </span>-<span class="w"> </span>Note:<span class="w"> </span>Debugging<span class="w"> </span>will<span class="w"> </span>proceed.<span class="w"> </span>Set<span class="w"> </span><span class="nv">PYDEVD_DISABLE_FILE_VALIDATION</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>disable<span class="w"> </span>this<span class="w"> </span>val
idation.
<span class="o">[</span>KernelApp<span class="o">]</span><span class="w"> </span>Connection<span class="w"> </span>file:<span class="w"> </span>/home/hades/.local/share/jupyter/runtime/kernel-a57a8231-bfea-468
<span class="m">0</span>-9f8b-6bf1b1e3a7ac.json
<span class="o">[</span>KernelApp<span class="o">]</span><span class="w"> </span>To<span class="w"> </span>connect<span class="w"> </span>a<span class="w"> </span>client:<span class="w"> </span>--existing<span class="w"> </span>kernel-a57a8231-bfea-4680-9f8b-6bf1b1e3a7ac.json
<span class="m">0</span>.00s<span class="w"> </span>-<span class="w"> </span>Debugger<span class="w"> </span>warning:<span class="w"> </span>It<span class="w"> </span>seems<span class="w"> </span>that<span class="w"> </span>frozen<span class="w"> </span>modules<span class="w"> </span>are<span class="w"> </span>being<span class="w"> </span>used,<span class="w"> </span>which<span class="w"> </span>may
<span class="m">0</span>.00s<span class="w"> </span>-<span class="w"> </span>make<span class="w"> </span>the<span class="w"> </span>debugger<span class="w"> </span>miss<span class="w"> </span>breakpoints.<span class="w"> </span>Please<span class="w"> </span>pass<span class="w"> </span>-Xfrozen_modules<span class="o">=</span>off
<span class="m">0</span>.00s<span class="w"> </span>-<span class="w"> </span>to<span class="w"> </span>python<span class="w"> </span>to<span class="w"> </span>disable<span class="w"> </span>frozen<span class="w"> </span>modules.
<span class="m">0</span>.00s<span class="w"> </span>-<span class="w"> </span>Note:<span class="w"> </span>Debugging<span class="w"> </span>will<span class="w"> </span>proceed.<span class="w"> </span>Set<span class="w"> </span><span class="nv">PYDEVD_DISABLE_FILE_VALIDATION</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>disable<span class="w"> </span>this<span class="w"> </span>validation.
</pre></div>
<p>According to <a href="https://stackoverflow.com/questions/75114841/debugger-warning-from-ipython-frozen-modules">this Stack Overflow post</a> the output, though scary-looking, is only a warning, and you should be able to ignore it. It's happening because python 3.11 uses a "frozen" version of python with code objects for some of the built-in python modules that get loaded when the interpreter starts up already pre-allocated in order to reduce their load time during python's start up (i.e. they set it up to start faster), and their doing this means that the debugger might not work correctly - but since I'm not using the debugger, it shouldn't matter.</p>
<ul class="org-ul">
<li><a href="https://docs.python.org/3/whatsnew/3.11.html#faster-startup">Python Note on their freezing the modules</a></li>
<li><a href="https://wiki.python.org/moin/Freeze">Python documentation of "freezing"</a></li>
</ul>
<p>Ah, but there's always a problem lurking behind the advice to ignore "harmless warnings". Even with the kernel running, I couldn't get python/jupyter to work in my org-babel source blocks, so there was more to do.</p>
</div>
</div>
<div class="outline-2" id="outline-container-org33639e4">
<h2 id="org33639e4">Getting emacs-jupyter Working</h2>
<div class="outline-text-2" id="text-org33639e4"></div>
<div class="outline-3" id="outline-container-orgc1a3227">
<h3 id="orgc1a3227">The Problem</h3>
<div class="outline-text-3" id="text-orgc1a3227">
<p>The first clue as to what might be happing was this line in emacs' startup messages.</p>
<pre class="example">
Symbol’s function definition is void: org-babel-execute:jupyter-python
</pre>
<p>It looked like <a href="https://github.com/emacs-jupyter/jupyter">emacs-jupyter</a> wasn't loading properly. There was also this message in the output:</p>
<pre class="example">
Error retrieving kernelspecs: (json-number-format 5)
</pre>
<p>Searching for that error-message brought up this bug-report on github:</p>
<ul class="org-ul">
<li><a href="https://github.com/emacs-jupyter/jupyter/issues/436">https://github.com/emacs-jupyter/jupyter/issues/436</a></li>
</ul>
<p>Wherein the author of the bug-report mentions that loading emacs-jupyter is failing because it's trying to parse the output of jupyter and the warnings I was seeing causes it to fail (the bug-report references a different jupyter command, but the problematic output is the same).</p>
</div>
</div>
<div class="outline-3" id="outline-container-org425312d">
<h3 id="org425312d">Testing Turning Off the Warning</h3>
<div class="outline-text-3" id="text-org425312d">
<p>The first thing I tried was to follow the directions in the output and supress the warnings by setting an environment variable.</p>
<div class="highlight">
<pre><span></span><span class="nb">set</span><span class="w"> </span>--universal<span class="w"> </span>--export<span class="w"> </span>PYDEVD_DISABLE_FILE_VALIDATION<span class="w"> </span><span class="m">1</span>
</pre></div>
<p><b>Note:</b> This is fish-shell syntax.</p>
<p>I restarted the jupyter kernel and the warnings had gone away, so this much worked.</p>
</div>
</div>
<div class="outline-3" id="outline-container-org13d2174">
<h3 id="org13d2174">Really Turning Off the Warning</h3>
<div class="outline-text-3" id="text-org13d2174">
<p>Setting the environment variable at the command-line changes the environment for my user, but I'm running <a href="https://www.emacswiki.org/emacs/EmacsAsDaemon">emacs as a daemon</a> so I needed to edit the <code>systemctl</code> file for my emacs service. I opened up the <code>~/.config/systemd/user/emacs.service</code> file in emacs and added the line to set the environment variable for the emacs daemon.</p>
<div class="highlight">
<pre><span></span><span class="k">[Service]</span>
<span class="na">Environment</span><span class="o">=</span><span class="s">"PYDEVD_DISABLE_FILE_VALIDATION=1"</span>
</pre></div>
<p>Then I restarted the service.</p>
<div class="highlight">
<pre><span></span>systemctl<span class="w"> </span>restart<span class="w"> </span>--user<span class="w"> </span>emacs
</pre></div>
<p>Which gave me a warning that my changes to the configuration have to be re-loaded before restarting the service.</p>
<pre class="example">
Warning: The unit file, source configuration file or drop-ins of emacs.service changed on disk
. Run 'systemctl --user daemon-reload' to reload units.
</pre>
<p>Oops.</p>
<div class="highlight">
<pre><span></span>systemctl<span class="w"> </span>--user<span class="w"> </span>daemon-reload
systemctl<span class="w"> </span>restart<span class="w"> </span>--user<span class="w"> </span>emacs
</pre></div>
<p>This time the emacs startup messages didn't have the jupyter errors so it looked like things were fixed.</p>
</div>
</div>
</div>
<div class="outline-2" id="outline-container-orga56231b">
<h2 id="orga56231b">Swapping a Virtual Environment For pipx</h2>
<div class="outline-text-2" id="text-orga56231b">
<p>Suppressing the warnings <i>pretty much</i> solved the problem, but while I was getting this fixed I was also trying to set up a USB Windows installer using <a href="https://github.com/WoeUSB/WoeUSB">WoeUSB</a> and found that pipx couldn't install it because of a dependency error. Pipx is good at installing some standalone python commands but it won't install things that are just libraries and it seems to sometimes also have problems installing dependencies for the commands that it <i>will</i> install. This has come up for me before, and the old solution was just for me to install the dependencies separately using <code>pip</code> before trying to install whatever it was that I was installing with pipx. Now, though, since ubuntu is trying to keep you from installing python modules globally, installing the dependencies means they either have to be available through <code>apt</code> or you have to set up a virtual environment and install them there (when I say <i>have to</i> I mean that since that's the way I know how to do it, that's the way I have to do it, not that there aren't other ways to do it that I just don't know about).</p>
<p>Doing it this way is easy enough, since I use python virtual environments a lot anyway, but then I ran into another problem which was that once I got the virtual environment set up I found out I had to run woeUSB as root, which then bypasses the whole virtual environment setup. The solution to that was to pass the full path to the virtual environment's woeUSB launcher to <code>sudo</code>, but it took enough time experimenting with other ways to do it before I got to that step that I decided I should minimalize how much I use pipx as much as possible - and in particular I should avoid using it with my emacs setup, since emacs will sometimss just quietly fail if there's a python-based error and it's only when things don't work that I'll realize there's a problem. So I decided to go with a dedicated virtual environment instead of installing jupyter with pipx.</p>
<p>This, once again was not a big deal in hindsight, but it took enough experimenting with other options before coming to the conclusion that this was the way to go that I thought I should make a note to my future self about it. To get jupyter working with jupyter-emacs:</p>
<ul class="org-ul">
<li>create a virtual environment (<code>python3 -m venv emacs-environment</code>) in the <code>.virtualenvs</code> folder</li>
<li>activate it, then use pip to install <code>wheels</code> and <code>jupyter</code></li>
</ul>
<p>In the <code>/.emacs.d/init.el</code> file, activate the virtual environment <i>before</i> you load emacs-jupyter or anything else that needs python:</p>
<div class="highlight">
<pre><span></span><span class="p">(</span><span class="nf">require</span><span class="w"> </span><span class="ss">'pyvenv</span><span class="p">)</span>
<span class="p">(</span><span class="nf">pyvenv-activate</span><span class="w"> </span><span class="s">"~/.virtualenvs/emacs-environment"</span><span class="p">)</span>
</pre></div>
<p>Then restart emacs. So far this seems to have fixed it.</p>
</div>
</div>
<div class="outline-2" id="outline-container-orgd7f199b">
<h2 id="orgd7f199b">Other Links</h2>
<div class="outline-text-2" id="text-orgd7f199b">
<ul class="org-ul">
<li>EmacsWiki: Emacs As Daemon [Internet]. [cited 2023 May 28]. Available from: <a href="https://www.emacswiki.org/emacs/EmacsAsDaemon#h5o-2">https://www.emacswiki.org/emacs/EmacsAsDaemon#h5o-2</a></li>
<li>Schäfer J. pyvenv.el, Python virtual environment support for Emacs [Internet]. 2023 [cited 2023 May 28]. Available from: <a href="https://github.com/jorgenschaefer/pyvenv">https://github.com/jorgenschaefer/pyvenv</a></li>
</ul>
</div>
</div>
</div>
<aside class="postpromonav">
<nav>
<ul class="tags" itemprop="keywords">
<li><a class="tag p-category" href="../../categories/emacs/" rel="tag">emacs</a></li>
<li><a class="tag p-category" href="../../categories/jupyter/" rel="tag">jupyter</a></li>
<li><a class="tag p-category" href="../../categories/python/" rel="tag">python</a></li>
<li><a class="tag p-category" href="../../categories/troubleshooting/" rel="tag">troubleshooting</a></li>
<li><a class="tag p-category" href="../../categories/ubuntu/" rel="tag">ubuntu</a></li>
</ul>
<ul class="pager hidden-print">
<li class="previous"><a href="../kernel-panic-at-the-lunar-lobster/" rel="prev" title="Kernel Panic At the Lunar Lobster">Previous post</a></li>
<li class="next"><a href="../fish-mocha-chai-a-local-global-installation-in-ubuntu/" rel="next" title="Fish, Mocha, Chai - A Local Global Installation In Ubuntu">Next post</a></li>
</ul>
</nav>
</aside>
</article>
<!--End of body content-->
<footer id="footer">Scribbled by the <a href="mailto:cloisteredmonkey.jmark@slmail.me">Cloistered Monkey</a> - Powered by <a href="https://getnikola.com" rel="nofollow">Nikola</a>
<div id="license" xmlns:cc="http://creativecommons.org/ns#">This work is licensed under <a href="http://creativecommons.org/licenses/by/4.0/?ref=chooser-v1" rel="license noopener noreferrer" style="display:inline-block;" target="_blank">CC BY 4.0 <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"></a></div>
</footer>
</div>
</div>
<script src="../../assets/js/all-nocdn.js"></script>
<script>

    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
</script>
</body>
</html>
