<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="How I use =pip-tools= and =pipdeptree=.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>pip-tools and pipdeptree | The Cloistered Monkey</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://necromuralist.github.io/posts/pip-tools-and-pipdeptree/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script><meta name="author" content="Cloistered Monkey">
<link rel="prev" href="../setting-up-the-rtl-8812au-realtek-usb-adapter-on-a-raspberry-pi-3/" title="Setting Up the RTL 8812AU Realtek USB Adapter on a Raspberry Pi 3" type="text/html">
<meta property="og:site_name" content="The Cloistered Monkey">
<meta property="og:title" content="pip-tools and pipdeptree">
<meta property="og:url" content="https://necromuralist.github.io/posts/pip-tools-and-pipdeptree/">
<meta property="og:description" content="How I use =pip-tools= and =pipdeptree=.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-06-09T12:52:57-07:00">
<meta property="article:tag" content="python programs">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-default navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://necromuralist.github.io/">

                <span id="blog-title">The Cloistered Monkey</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>
                </li>
<li>
<a href="../../rss.xml">RSS feed</a>
            </li>
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Projects <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../../machine-learning-projects/">Machine Learning</a>
                    </li>
<li>
<a href="https://necromuralist.github.io/p5_explorations/">P5 Explorations</a>
                    </li>
<li>
<a href="https://necromuralist.github.io/tddmachinelearning/">TDD Machine Learning</a>
                    </li>
<li>
<a href="https://necromuralist.github.io/student_intervention/">Student Intervention Project</a>
                    </li>
<li>
<a href="https://necromuralist.github.io/boston_housing/">Boston Housing Project</a>
                    </li>
<li>
<a href="https://necromuralist.github.io/data_science/">Data Science With Python</a>
            </li>
</ul>
</li>
</ul>
<!-- Google custom search --><form method="get" action="https://www.google.com/search" class="navbar-form navbar-right" role="search">
<div class="form-group">
<input type="text" name="q" class="form-control" placeholder="Search">
</div>
<button type="submit" class="btn btn-primary">
	<span class="glyphicon glyphicon-search"></span>
</button>
<input type="hidden" name="sitesearch" value="https://necromuralist.github.io/">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right">
<li>
    <a href="index.org" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">pip-tools and pipdeptree</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    <a href="../../authors/cloistered-monkey/">Cloistered Monkey</a>
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2018-06-09T12:52:57-07:00" itemprop="datePublished" title="2018-06-09 12:52">2018-06-09 12:52</time></a></p>
            
        <p class="sourceline"><a href="index.org" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div id="outline-container-org52c5754" class="outline-2">
<h2 id="org52c5754">Introduction</h2>
<div class="outline-text-2" id="text-org52c5754">
<p>
I was looking for a way to update python dependencies that I'd installed with <a href="https://pip.pypa.io/en/stable/">pip</a> when I stumbled upon <a href="https://github.com/jazzband/pip-tools/">pip-tools</a>. I'm not particularly good about keeping everything in sync and up-to-date so I'm hoping that this will make it easier to do and thus more likely that I'll do it. It's been a little while since I first used it and I had to look it up, so these are my notes to my future self.
</p>
</div>
</div>
<div id="outline-container-org935ab42" class="outline-2">
<h2 id="org935ab42">First pipdeptree</h2>
<div class="outline-text-2" id="text-org935ab42">
<p>
<code>pip-tools</code> installs a command named <code>pip-compile</code> which will use either the requirements you put in your <code>setup.py</code> file or a special file named <code>requirements.in</code> (if you call it this you don't have to pass in the filename, otherwise you have to tell it where to look). Unless there's only a few requirements I prefer to use a separate file, rather than <code>setup.py</code>, since it makes it clearer and more likely that I'll keep it up to date. The <code>requirements.in</code> file is a list of your dependencies but unlike the <code>requirements.txt</code> file, it doesn't have version numbers, the version numbers are added when you call the <code>pip-compile</code> command. 
</p>

<p>
So where does the <code>requirements.in</code> file come from? You have to make it. <i>But if you're editing things by hand, doesn't this kind of make it less likely you'll maintain it?</i> Yes, which is where <a href="https://github.com/naiquevin/pipdeptree"><code>pipdeptree</code></a> comes in. <code>pipdeptree</code> will list all the python dependencies you installed as well as everything those dependencies pulled in as their dependencies. It's usefull to take a look at how a dependency you didn't directly install got into your virtual environment. You can install it from pypi.
</p>

<div class="highlight"><pre><span></span>pip install pipdeptree
</pre></div>

<p>
Here's its help output.
</p>

<div class="highlight"><pre><span></span>pipdeptree -h
</pre></div>

<pre class="example">
usage: pipdeptree [-h] [-v] [-f] [-a] [-l] [-u] [-w [{silence,suppress,fail}]]
                  [-r] [-p PACKAGES] [-j] [--json-tree]
                  [--graph-output OUTPUT_FORMAT]

Dependency tree of the installed python packages

optional arguments:
  -h, --help            show this help message and exit
  -v, --version         show program's version number and exit
  -f, --freeze          Print names so as to write freeze files
  -a, --all             list all deps at top level
  -l, --local-only      If in a virtualenv that has global access do not show
                        globally installed packages
  -u, --user-only       Only show installations in the user site dir
  -w [{silence,suppress,fail}], --warn [{silence,suppress,fail}]
                        Warning control. "suppress" will show warnings but
                        return 0 whether or not they are present. "silence"
                        will not show warnings at all and always return 0.
                        "fail" will show warnings and return 1 if any are
                        present. The default is "suppress".
  -r, --reverse         Shows the dependency tree in the reverse fashion ie.
                        the sub-dependencies are listed with the list of
                        packages that need them under them.
  -p PACKAGES, --packages PACKAGES
                        Comma separated list of select packages to show in the
                        output. If set, --all will be ignored.
  -j, --json            Display dependency tree as json. This will yield "raw"
                        output that may be used by external tools. This option
                        overrides all other options.
  --json-tree           Display dependency tree as json which is nested the
                        same way as the plain text output printed by default.
                        This option overrides all other options (except
                        --json).
  --graph-output OUTPUT_FORMAT
                        Print a dependency graph in the specified output
                        format. Available are all formats supported by
                        GraphViz, e.g.: dot, jpeg, pdf, png, svg
</pre>

<p>
If you look at the options you can see that there's a <code>--freeze</code> option, that's what we'll be using. Let's look at some of what that looks like.
</p>

<div class="highlight"><pre><span></span>pipdeptree --freeze <span class="p">|</span> head
</pre></div>

<pre class="example">
ghp-import2==1.0.1
graphviz==0.8.3
Nikola==7.8.15
  blinker==1.4
  docutils==0.14
  doit==0.31.1
    cloudpickle==0.5.3
    pyinotify==0.9.6
  Logbook==1.4.0
  lxml==4.2.1
</pre>

<p>
So it looks like the output of <code>pip freeze</code> except it puts the packages you installed flush-left and then uses indentation to indicate what that package installed. In the example above, I installed <a href="https://www.getnikola.com/handbook.html">Nikola</a>, then Nikola installed <a href="http://pydoit.org/">doit</a>, and doit installed <a href="https://github.com/cloudpipe/cloudpickle">cloudpickle</a> and <a href="https://github.com/seb-m/pyinotify">pyinotify</a>. I kind of remember needing to install <code>pyinotify</code> myself, but maybe <code>pydeptree</code> caught that it was a dependency that <code>doit</code> is using. Anyway.
</p>

<p>
For our <code>requirements.in</code> file we only want the names, and although there might be a reason to keep the entire tree, I think it makes it easier to understand what I'm using if the file only holds the dependencies at the top-level (the ones that I'm using directly, rather than being a dependency of a dependency). So, we'll use a little <a href="https://en.wikipedia.org/wiki/Grep">grep</a>. First, since I'm a python-programmer I'm going to give it the <code>-P</code> flag to use perl escape codes. Then I'll match only the entries that are flush left by using the <code>^\s</code> expression to match lines that start with spaces and the <code>-v</code> option to invert the outcome (only show lines that don't match).
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-left">
<col class="org-left">
</colgroup>
<thead><tr>
<th scope="col" class="org-left">grep</th>
<th scope="col" class="org-left">Description</th>
</tr></thead>
<tbody>
<tr>
<td class="org-left">
<code>-P</code>, <code>--perl-regexp</code>
</td>
<td class="org-left">Use perl regular expression syntax</td>
</tr>
<tr>
<td class="org-left"><code>^</code></td>
<td class="org-left">Match the beggining of a line</td>
</tr>
<tr>
<td class="org-left"><code>\s</code></td>
<td class="org-left">Match whitespace</td>
</tr>
<tr>
<td class="org-left">
<code>-v</code>, <code>--invert-match</code>
</td>
<td class="org-left">Show lines that don't match</td>
</tr>
</tbody>
</table>
<p>
First, let's see how many total dependencies there are.
</p>

<div class="highlight"><pre><span></span>pipdeptree --freeze <span class="p">|</span> wc -l
</pre></div>

<pre class="example">
: 160
</pre>

<p>
So there are 160 dependencies total. How many did I install?
</p>


<div class="highlight"><pre><span></span>pipdeptree --freeze <span class="p">|</span> grep -vP <span class="s2">"^\s"</span>
</pre></div>

<pre class="example">
ghp-import2==1.0.1
graphviz==0.8.3
Nikola==7.8.15
notebook==5.5.0
pip-tools==2.0.2
pipdeptree==0.12.1
virtualfish==1.0.6
watchdog==0.8.3
webassets==0.12.1
wheel==0.31.1
ws4py==0.5.1
</pre>

<div class="highlight"><pre><span></span>pipdeptree --freeze <span class="p">|</span> grep -vP <span class="s2">"^\s"</span> <span class="p">|</span> wc -l
</pre></div>

<pre class="example">
: 11
</pre>

<p>
So out of the 158 dependencies, 11 were ones that I installed, and that includes <a href="https://github.com/adambrenecki/virtualfish">virtualfish</a> (to work with virtual-environments with the <a href="https://fishshell.com/">fish shell</a>), <a href="https://github.com/pypa/wheel">wheel</a> (to build wheels, for dependencies), and pip-tools, pipdeptree, and <a href="https://github.com/xflr6/graphviz">graphviz</a> which I installed to make the requirements files. So really there are only 8 that I installed to get Nikola working.
</p>

<p>
<i>So we're done, right?</i> Not yet, we need to get rid of the <code>==</code> and version numbers. I hadn't known that grep had this feature, since I normally use python instead of grep, but grep has an <code>--only-matching</code> option that will discard the parts of the line that don't match. 
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<colgroup>
<col class="org-left">
<col class="org-left">
</colgroup>
<thead><tr>
<th scope="col" class="org-left"><code>grep</code></th>
<th scope="col" class="org-left">Description</th>
</tr></thead>
<tbody>
<tr>
<td class="org-left">
<code>-o</code>, <code>--only-matching</code>
</td>
<td class="org-left">Only show the parts of the line that match</td>
</tr>
<tr>
<td class="org-left"><code>\w</code></td>
<td class="org-left">Match alpha-numeric character and underscores</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span>pipdeptree --freeze <span class="p">|</span> grep -vP <span class="s2">"^\s"</span> <span class="p">|</span> grep -oP <span class="s2">"^[\w]+"</span>
</pre></div>

<pre class="example">
ghp
graphviz
Nikola
notebook
pip
pipdeptree
virtualfish
watchdog
webassets
wheel
ws4py
</pre>

<p>
If you look at the first line you might notice that it says <code>ghp</code>, but we really want <code>ghp-import2</code>. I guess hyphens aren't part of the alpha-numeric set. We'll add it to the character class definition.
</p>

<div class="highlight"><pre><span></span>pipdeptree --freeze <span class="p">|</span> grep -vP <span class="s2">"^\s"</span> <span class="p">|</span> grep -oP <span class="s2">"^[\w\-]+"</span>
</pre></div>

<pre class="example">
ghp-import2
graphviz
Nikola
notebook
pip-tools
pipdeptree
virtualfish
watchdog
webassets
wheel
ws4py
</pre>

<p>
That looks better. There are probaby other exceptions that have to be added for other installations, but this looks like enough for us. Now we can redirect this to a <code>requirements.in</code> file and we're ready for <code>pip-tools</code>.
</p>

<pre class="example">
pipdeptree --freeze | grep -vP "^\s" | grep -oP "^[\w]+" &gt; requirements.in
</pre>
</div>
</div>
<div id="outline-container-org2cb58c5" class="outline-2">
<h2 id="org2cb58c5">pip-compile</h2>
<div class="outline-text-2" id="text-org2cb58c5">
<p>
<code>pip-compile</code> will read in the <code>requirements.in</code> file and add the version numbers so that we can create a <code>requirements.txt</code> file.
</p>

<div class="highlight"><pre><span></span>pip-compile requirements.in <span class="p">|</span> head
</pre></div>

<pre class="example">
#
# This file is autogenerated by pip-compile
# To update, run:
#
#    pip-compile --output-file requirements.txt requirements.in
#
argh==0.26.2              # via watchdog
backcall==0.1.0           # via ipython
bleach==2.1.3             # via nbconvert
blinker==1.4              # via nikola
</pre>

<p>
You actually don't need to pass in the input file, but that's what the instructions said to do so I'll leave it in. Now we can redirect this to <code>requirements.in</code> and we'll have our current dependencies file.
</p>

<pre class="example">
pip-compile requirements.in &gt; requirements.txt
</pre>
</div>
</div>

<div id="outline-container-orga17c891" class="outline-2">
<h2 id="orga17c891">Well, that was a lot of work just for that.</h2>
<div class="outline-text-2" id="text-orga17c891">
<p>
If we stopped at this point we'd have:
</p>
<ul class="org-ul">
<li>a way to check who installed what using <code>pipdeptree</code> (as well as a way to plot the dependencies as a graph)</li>
<li>a way to separate out our dependencies into a separate file (<code>requirements.in</code>) to make it easier to read</li>
<li>a way to create our <code>requirements.txt</code> file using our <code>requirements.in</code> file</li>
</ul>
<p>
I think that's kind of nice already, especially if you end up with a lot of dependencies. Try working with <a href="http://www.sphinx-doc.org/en/master/">sphinx</a> and <a href="http://scikit-learn.org/stable/">scikit-learn</a> and you'll see things start to explode. But of course, there's always more. 
</p>
</div>

<div id="outline-container-org33eeb14" class="outline-3">
<h3 id="org33eeb14">Upgrade</h3>
<div class="outline-text-3" id="text-org33eeb14">
<p>
You can run  <code>pip-compile</code> with the <code>--upgrade</code> option to try and update dependencies whenever you want to make sure you have the latest of everything (you can do it per-package too, but nah).
</p>

<div class="highlight"><pre><span></span>pip-compile --upgrade <span class="p">|</span> head
</pre></div>

<pre class="example">
#
# This file is autogenerated by pip-compile
# To update, run:
#
#    pip-compile --output-file requirements.txt requirements.in
#
argh==0.26.2              # via watchdog
backcall==0.1.0           # via ipython
bleach==2.1.3             # via nbconvert
blinker==1.4              # via nikola
</pre>

<p>
This will upgrade your installation but not update the <code>requirements.txt</code> file, so you can test it out and see if everything works before updating the <code>requirements.txt</code>. If things don't work out, you could reinstall from the <code>requirements.txt</code> file, but see the next section for another way. 
</p>
</div>
</div>

<div id="outline-container-org22f365f" class="outline-3">
<h3 id="org22f365f">Sync</h3>
<div class="outline-text-3" id="text-org22f365f">
<p>
<code>pip-tools</code> also installed a command called <code>pip-sync</code> which will keep you in sync with what is in the requirements file, so as long as <code>requirements.txt</code> it is always a working version, you can sync up with it to avoid problems with dependency changes. This is different from the <code>--upgrade</code> option in that it will only install the exact version in the requirements file.
</p>

<div class="highlight"><pre><span></span>pip-sync
</pre></div>

<pre class="example">
Collecting backcall==0.1.0
Collecting bleach==2.1.3
  Using cached https://files.pythonhosted.org/packages/30/b6/a8cffbb9ab4b62b557c22703163735210e9cd857d533740c64e1467d228e/bleach-2.1.3-py2.py3-none-any.whl
Collecting certifi==2018.4.16
  Using cached https://files.pythonhosted.org/packages/7c/e6/92ad559b7192d846975fc916b65f667c7b8c3a32bea7372340bfe9a15fa5/certifi-2018.4.16-py2.py3-none-any.whl
Collecting cloudpickle==0.5.3
  Using cached https://files.pythonhosted.org/packages/e7/bf/60ae7ec1e8c6742d2abbb6819c39a48ee796793bcdb7e1d5e41a3e379ddd/cloudpickle-0.5.3-py2.py3-none-any.whl
Successfully installed backcall-0.1.0 bleach-2.1.3 certifi-2018.4.16 cloudpickle-0.5.3 decorator-4.3.0 doit-0.31.1 ipykernel-4.8.2 ipython-6.4.0 jedi-0.12.0 jupyter-client-5.2.3 logbook-1.4.0 lxml-4.2.1 natsort-5.3.2 nikola-7.8.15 notebook-5.5.0 parso-0.2.1 pexpect-4.6.0 pillow-5.1.0 python-dateutil-2.7.3 send2trash-1.5.0 tornado-5.0.2 virtualenv-16.0.0 virtualfish-1.0.6 wheel-0.31.1 ws4py-0.5.1
#+END_SRC

Since I upgraded the installation the =requirements.txt= file is now behind the latests versions so by syncing I undid the upgrade. This time I'll upgrade again and save the output.

#+BEGIN_SRC sh :results none
pip-compile --upgrade &gt; requirements.txt
#+END_SRC

So now the file and my installation should be in sync.

#+BEGIN_SRC sh :results output
pip-sync
#+END_SRC

#+BEGIN_EXAMPLE
: Everything up-to-date
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcfd19b2" class="outline-2">
<h2 id="orgcfd19b2">Conclusion</h2>
<div class="outline-text-2" id="text-orgcfd19b2">
<p>
So there you have it, how to keep dependencies synced. The <a href="https://pypi.org/project/pip-tools/">README</a> for pip-tools is much briefer, but I thought I'd add a little more detail to the part of it that I plan to use the most.
</p>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/python-programs/" rel="tag">python programs</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../setting-up-the-rtl-8812au-realtek-usb-adapter-on-a-raspberry-pi-3/" rel="prev" title="Setting Up the RTL 8812AU Realtek USB Adapter on a Raspberry Pi 3">Previous post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2018         <a href="mailto:necromuralist@protonmail.com">Cloistered Monkey</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png"></a><br>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
