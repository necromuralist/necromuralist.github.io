<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Notes on getting pytorch, cuda, and conda working in docker">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Cuda, Conda, Docker...ugh | The Cloistered Monkey</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://necromuralist.github.io/posts/cuda-conda-dockerugh/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="manifest" href="../../site.webmanifest">
<meta name="author" content="Cloistered Monkey">
<meta name="robots" content="noindex">
<meta property="og:site_name" content="The Cloistered Monkey">
<meta property="og:title" content="Cuda, Conda, Docker...ugh">
<meta property="og:url" content="https://necromuralist.github.io/posts/cuda-conda-dockerugh/">
<meta property="og:description" content="Notes on getting pytorch, cuda, and conda working in docker">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2021-12-06T18:04:16-08:00">
<meta property="article:tag" content="conda">
<meta property="article:tag" content="cuda">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="howto">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-light
bg-light
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="../../">

            <span id="blog-title">The Cloistered Monkey</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item">
<a href="../../pages/" class="nav-link">Pages</a>
                </li>
<li class="nav-item">
<a href="../../archive.html" class="nav-link">Archive</a>
                </li>
<li class="nav-item">
<a href="../../categories/" class="nav-link">Tags</a>
                </li>
<li class="nav-item">
<a href="../../rss.xml" class="nav-link">RSS feed</a>
            </li>
<li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Projects</a>
            <div class="dropdown-menu">
                    <a href="https://necromuralist.github.io/Bowling-For-Data/" class="dropdown-item">Bowling For Data</a>
                    <a href="https://necromuralist.github.io/Anechoic-Echolalia/" class="dropdown-item">Anechoic Echolalia</a>
                    <a href="https://necromuralist.github.io/Ape-Iron/" class="dropdown-item">Ape Iron</a>
                    <a href="https://necromuralist.github.io/Neurotic-Networking/" class="dropdown-item">Neurotic Networking</a>
                    <a href="https://necromuralist.github.io/student_intervention/" class="dropdown-item">Student Intervention Project</a>
                    <a href="https://necromuralist.github.io/boston_housing/" class="dropdown-item">Boston Housing Project</a>
                    <a href="https://necromuralist.github.io/data_science/" class="dropdown-item">Data Science With Python</a>
                    <a href="https://necromuralist.github.io/Visions-Voices-Data/" class="dropdown-item">Visions, Voices, Data</a>
            </div>

                
            </li>
</ul>
<!-- Google custom search --><form method="get" action="https://www.google.com/search" class="navbar-form navbar-right" role="search">
<div class="form-group">
<input type="text" name="q" class="form-control" placeholder="Search">
</div>
<!-- 
<button type="submit" class="btn btn-primary">
	<span class="glyphicon glyphicon-search"></span>
</button>
-->
<input type="hidden" name="sitesearch" value="https://necromuralist.github.io/">
</form>
<!-- End of custom search -->


            <ul class="navbar-nav navbar-right">
<li class="nav-item">
    <a href="index.org" id="sourcelink" class="nav-link">Source</a>
    </li>


                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Cuda, Conda, Docker...ugh</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    <a class="u-url" href="../../authors/cloistered-monkey/">Cloistered Monkey</a>
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2021-12-06T18:04:16-08:00" itemprop="datePublished" title="2021-12-06 18:04">2021-12-06 18:04</time></a>
            </p>
            
        <p class="sourceline"><a href="index.org" class="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div id="outline-container-org989eea0" class="outline-2">
<h2 id="org989eea0">The Beginning</h2>
<div class="outline-text-2" id="text-org989eea0">
<p>
I haven't been doing anything with pytorch recently so I decided to restart by setting up a docker container on my machine with a beefier nvidia card than the machine I had been using. I've learned a little bit more about docker since I built my earlier container so I decided to update the image and found it both easier and harder than I remember it being. It went easier because I knew more or less what I had to do so I knew what to look up. Harder because there's some workarounds that you have to work with that weren't there before, and I decided to stick with <code>conda</code>, which seems to add an extra layer of difficulty compared to pip and virtualenv when you use docker. But, anyway, enough with the whining, here's the stuff.
</p>

<p>
<b><b>Note:</b></b> I'm doing this on Ubuntu 21.10.
</p>
</div>
</div>

<div id="outline-container-org29e865e" class="outline-2">
<h2 id="org29e865e">Nvidia-Container-Toolkit and Ubuntu</h2>
<div class="outline-text-2" id="text-org29e865e">
<p>
The first thing you should do is install the <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#docker">nvidia-container-toolkit</a>. The instructions say to add the repository this way:
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
This introduces two problems for me. The first is that this assumes you use bash, but I'm using fish so the command doesn't work. This is no big deal since I just looking in the <code>/etc/os-release</code> file to get the <code>ID</code> and <code>VERSION_ID</code> and wrote it out.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
But then this introduces the second problem - the second curl fails with the message:
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
It turns out there's an <a href="https://github.com/NVIDIA/nvidia-docker/issues/1574">open bug report</a> on GitHub, with a comment that only Long-Term-Support versions are supported. The commenter suggested using 18.04 for some reason, but I went with 20.04 and it seemed to work.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'
</module></module></module></module>
</div>
</div>

<div id="outline-container-orgb2416f8" class="outline-2">
<h2 id="orgb2416f8">The Cuda Image</h2>
<div class="outline-text-2" id="text-orgb2416f8">
<p>
Now that I was setup to run the container I ran a test.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
Which gave me an error, something like <code>Error response from daemon</code> (I don't remember exactly), which turns out to be the result of a pretty major flaw right now (as noted on the <a href="https://github.com/NVIDIA/libnvidia-container/issues/111">github issue for it</a>). One of the commenters <a href="https://github.com/NVIDIA/libnvidia-container/issues/111#issuecomment-932742403">posted a work-around for it</a> which seems to work.
</p>
</module>
</div>

<div id="outline-container-orgdd2f0c7" class="outline-3">
<h3 id="orgdd2f0c7">Edit /etc/nvidia-container-runtime/config.toml</h3>
<div class="outline-text-3" id="text-orgdd2f0c7">
<p>
In the file there's a line:
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
Uncomment it and set it to true.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
Okay, easy-peasy. All fixed, then, right? Well, doing this fix means that you now have to pass in more flags when you run the container. First you need to check what you have.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
Then when you run the container you need to pass in most of those things as <code>--device</code> arguments.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
You might not need to actually look in <code>/dev</code> first. I had to because the post on github was referring to a <code>/dev/nvidia1</code> device, but I don't have one. This appears to work, although it's a bit unwieldy.
</p>
</module></module></module></module>
</div>
</div>
</div>

<div id="outline-container-org1cf19ce" class="outline-2">
<h2 id="org1cf19ce">Now for Conda</h2>
<div class="outline-text-2" id="text-org1cf19ce">
<p>
This next bit probably shouldn't be registered as a problem, but the last time I tried to run pytorch in docker there was some kind of bug when I installed it with <code>pip</code> that went away when I installed it with <code>conda</code> so I decided to stick with cuda, but I also wanted to try and set it up the way I do with virtualenv - cached by docker and run non-root. This turns out to be much harder to do than with virtualenv for some reason. I looked through some posts on StackOverflow and elsewhere and didn't really see any good solutions, but <a href="https://towardsdatascience.com/conda-pip-and-docker-ftw-d64fe638dc45">this one on Toward Data Science</a> got close enough.
The way that post suggests is to change the shell that docker uses to <code>bash</code> and moving the <code>miniconda</code> install path into the home directory of the user that you want to run it.
</p>

<p>
I won't bother with all of the <code>Dockerfile</code>, but the basic changes are:
</p>

<p>
Change the shell.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
Switch to the user (assuming you added the user and home directory earlier in the docker file) and add an environment file to store the directory in (I don't think you need to use <code>ENV</code> but the post used it. I'll try <code>ARG</code> later).
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
Then install miniconda.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
Update conda.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'

<p>
Install the packages. This is where I added the caching to try and reduce the re-downloading of files. I don't really know if this helps a lot, to be truthful, but it's nice to have new things.
</p>

Traceback (most recent call last):
  File "/home/hades/.local/bin/pygmentize", line 5, in <module>
    from pygments.cmdline import main
ModuleNotFoundError: No module named 'pygments'
</module></module></module></module></module>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/conda/" rel="tag">conda</a></li>
            <li><a class="tag p-category" href="../../categories/cuda/" rel="tag">cuda</a></li>
            <li><a class="tag p-category" href="../../categories/docker/" rel="tag">docker</a></li>
            <li><a class="tag p-category" href="../../categories/howto/" rel="tag">howto</a></li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer">
            Contents © 2023         <a href="mailto:cloisteredmonkey.jmark@slmail.me">Cloistered Monkey</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
            
        </footer>
</div>
</div>


        <script src="../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
